<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–¶–µ–Ω—Ç—Ä –ö–æ–Ω—Ç—Ä–æ–ª—è –ö–∞—á–µ—Å—Ç–≤–∞</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/imask"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700;800&display=swap');
        body { font-family: 'Manrope', sans-serif; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }
        .animate-fade-in-up { animation: fadeInUp 0.8s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards; }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }
        .input-field {
            background-color: #1f2937; /* bg-gray-800 */
            border: 2px solid #374151; /* border-gray-700 */
            color: #d1d5db; /* text-gray-300 */
            transition: all 0.3s ease;
        }
        .input-field:focus {
            background-color: #374151; /* bg-gray-700 */
            border-color: #818cf8; /* border-indigo-400 */
            box-shadow: 0 0 0 2px rgba(129, 140, 248, 0.3);
        }
    </style>
</head>

<body class="bg-gray-900 min-h-screen w-full flex items-center justify-center p-4">
    <div class="w-full max-w-2xl mx-auto bg-gray-800/80 backdrop-blur-xl rounded-2xl shadow-2xl shadow-indigo-500/10 p-6 sm:p-8 border border-gray-700/60">
        
        <div id="main-content" class="animate-fade-in-up">
            <div class="text-center mb-8">
                <h1 class="text-4xl md:text-5xl font-extrabold text-indigo-400 tracking-tight">–û—Ç–∑—ã–≤.KZ</h1>
                <p class="text-gray-400 mt-2 text-lg">–í–∞—à–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –º–µ–Ω—è–µ—Ç –∫–∞—á–µ—Å—Ç–≤–æ</p>
            </div>
            
            <div id="user-profile" class="hidden my-6 p-5 bg-slate-800 rounded-2xl border border-slate-700 shadow-sm">
                <div class="flex justify-between items-center mb-3">
                    <p class="text-sm text-slate-400">–ü—Ä–æ—Ñ–∏–ª—å: <strong id="profile-phone" class="font-semibold text-slate-200"></strong></p>
                    <span id="profile-level-badge" class="font-bold text-sm px-3 py-1 rounded-full"></span>
                </div>
                <div class="w-full bg-slate-700 rounded-full h-2.5">
                    <div id="progress-bar" class="bg-indigo-500 h-2.5 rounded-full transition-all duration-500"></div>
                </div>
                <div class="flex justify-between items-center mt-2">
                    <p class="text-xs text-slate-400">–û—Ç–∑—ã–≤–æ–≤: <strong id="profile-count" class="font-medium text-slate-300"></strong></p>
                    <p id="next-level-text" class="text-xs text-indigo-400 font-semibold"></p>
                </div>
            </div>

            <form id="review-form" class="space-y-6">
                <div id="mission-container" class="bg-gray-700/50 p-5 rounded-xl border-2 border-dashed border-indigo-500/40 text-center">
                    <h3 class="font-bold text-lg text-indigo-300 mb-2">‚ö°Ô∏è –í–∞—à–∞ –º–∏—Å—Å–∏—è:</h3>
                    <p id="mission-text" class="text-gray-300/90"></p>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <input type="text" name="name" id="name-input" required class="w-full p-3 rounded-lg outline-none input-field" placeholder="–í–∞—à–µ –∏–º—è"/>
                    <input type="tel" name="phone" id="phone-input" required class="w-full p-3 rounded-lg outline-none input-field" placeholder="–ö–æ–Ω—Ç–∞–∫—Ç–Ω—ã–π –Ω–æ–º–µ—Ä"/>
                </div>
                
                <textarea name="reviewText" id="reviewText-input" rows="5" required class="w-full p-3 rounded-lg outline-none input-field" placeholder="–î–µ—Ç–∞–ª—å–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –æ—Ç–∑—ã–≤–∞... (min 50 –∑–Ω.)"></textarea>
                
                <div id="reward-container" class="text-center bg-emerald-900/50 text-emerald-200 p-4 rounded-xl font-bold text-lg border border-emerald-700 transition-all duration-300 opacity-0 scale-95"></div>
                
                <p id="form-error" class="text-red-400 text-sm text-center hidden font-semibold"></p>
                
                <button type="submit" id="submit-review-btn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-4 px-8 rounded-xl text-lg transition-all transform hover:scale-105 focus:outline-none focus:ring-4 focus:ring-indigo-400/50 disabled:bg-gray-600 disabled:cursor-not-allowed disabled:hover:scale-100">
                    –û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤ –∏ –ø–æ–ª—É—á–∏—Ç—å –±–∞–ª–ª—ã
                </button>
            </form>
        </div>

        <div id="success-message" class="hidden text-center py-8">
            <svg class="h-24 w-24 mx-auto text-emerald-400 mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
            <h2 class="text-3xl font-extrabold text-gray-100 mb-2">–ú–∏—Å—Å–∏—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∞!</h2>
            <div id="success-text" class="text-gray-300 mb-8 p-4 bg-gray-700/80 rounded-lg text-lg"></div>
            <button id="leave-another-review-btn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-lg">–í—ã–ø–æ–ª–Ω–∏—Ç—å –Ω–æ–≤—É—é –º–∏—Å—Å–∏—é</button>
        </div>

    </div>

<script type="module">
    // --- –ù–ê–°–¢–†–û–ô–ö–ò –°–ò–°–¢–ï–ú–´ ---
    const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyAu9w8cQTIbm6hucwKYPjRhwwiqU1uHwcxM_YzWmhDbTnFK_0nwGJ2HDS38Xd9Mu-5/exec'; 

    const LEVELS = {
        0: { name: '–ù–æ–≤–∏—á–æ–∫', color: 'bg-green-200/20 text-green-300', threshold: 0, multiplier: 1.0 },
        1: { name: '–ó–Ω–∞—Ç–æ–∫', color: 'bg-blue-200/20 text-blue-300', threshold: 5, multiplier: 1.1 },
        2: { name: '–†–µ–≤–∏–∑–æ—Ä', color: 'bg-purple-200/20 text-purple-300', threshold: 15, multiplier: 1.25 },
        3: { name: '–ê–º–±–∞—Å—Å–∞–¥–æ—Ä', color: 'bg-amber-200/20 text-amber-300', threshold: 50, multiplier: 1.5 }
    };
    const REWARDS = {
        BASE_REVIEW: 300,
    };
    const MISSIONS = [
        "–û—Ü–µ–Ω–∏—Ç–µ –∫–æ–º–ø–µ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å –∏ –≤–µ–∂–ª–∏–≤–æ—Å—Ç—å —Ñ–∞—Ä–º–∞—Ü–µ–≤—Ç–∞. –ü–æ–º–æ–≥ –ª–∏ –æ–Ω –≤–∞–º —Å –≤—ã–±–æ—Ä–æ–º?",
        "–ù–∞—Å–∫–æ–ª—å–∫–æ –±—ã—Å—Ç—Ä–æ –≤–∞—Å –æ–±—Å–ª—É–∂–∏–ª–∏? –ë—ã–ª–∞ –ª–∏ –æ—á–µ—Ä–µ–¥—å, –∏ –∫–∞–∫ –ø–µ—Ä—Å–æ–Ω–∞–ª —Å –Ω–µ–π —Å–ø—Ä–∞–≤–ª—è–ª—Å—è?",
        "–û—Ü–µ–Ω–∏—Ç–µ —á–∏—Å—Ç–æ—Ç—É –∏ –ø–æ—Ä—è–¥–æ–∫ –≤ –∞–ø—Ç–µ–∫–µ. –í—Å–µ –ª–∏ —Ü–µ–Ω–Ω–∏–∫–∏ –Ω–∞ –º–µ—Å—Ç–µ –∏ –ª–µ–≥–∫–æ —á–∏—Ç–∞–µ–º—ã?",
        "–ö–∞–∫ –≤—ã –æ—Ü–µ–Ω–∏–≤–∞–µ—Ç–µ –∞—Å—Å–æ—Ä—Ç–∏–º–µ–Ω—Ç –ª–µ–∫–∞—Ä—Å—Ç–≤ –∏ —Å–æ–ø—É—Ç—Å—Ç–≤—É—é—â–∏—Ö —Ç–æ–≤–∞—Ä–æ–≤? –ù–∞—à–ª–∏ –ª–∏ –≤—ã –≤—Å—ë, —á—Ç–æ –∏—Å–∫–∞–ª–∏?",
        "–ó–∞–¥–∞–π—Ç–µ —Ñ–∞—Ä–º–∞—Ü–µ–≤—Ç—É –≤–æ–ø—Ä–æ—Å –æ –ø–æ–±–æ—á–Ω—ã—Ö —ç—Ñ—Ñ–µ–∫—Ç–∞—Ö –∏–ª–∏ –∞–Ω–∞–ª–æ–≥–µ –ø—Ä–µ–ø–∞—Ä–∞—Ç–∞. –û–ø–∏—à–∏—Ç–µ, –Ω–∞—Å–∫–æ–ª—å–∫–æ –ø–æ–ª–Ω—ã–º –∏ –ø–æ–Ω—è—Ç–Ω—ã–º –±—ã–ª –æ—Ç–≤–µ—Ç."
    ];

    // --- –°–û–°–¢–û–Ø–ù–ò–ï –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø ---
    const state = { userLevel: LEVELS[0], submissionCount: 0, points: 0 };

    // --- –≠–õ–ï–ú–ï–ù–¢–´ DOM ---
    const form = document.getElementById('review-form');
    const phoneInput = document.getElementById('phone-input');
    const nameInput = document.getElementById('name-input');
    const reviewTextInput = document.getElementById('reviewText-input');
    const rewardContainer = document.getElementById('reward-container');
    const formError = document.getElementById('form-error');
    const submitBtn = document.getElementById('submit-review-btn');

    // --- –£–¢–ò–õ–ò–¢–´ ---
    const normalizePhone = (phone) => {
        const d = phone.replace(/\D/g, '');
        return d.startsWith('8') ? '7' + d.substring(1) : (d.startsWith('7') ? d : '7' + d);
    };
    const isValidPhone = (phone) => normalizePhone(phone).length === 11;

    const getUserData = (phone) => {
        const normalized = normalizePhone(phone);
        const data = localStorage.getItem(normalized);
        const userData = data ? JSON.parse(data) : { submissionCount: 0 };
        
        let levelKey = 0;
        for (const key in LEVELS) {
            if (userData.submissionCount >= LEVELS[key].threshold) {
                levelKey = key;
            }
        }
        userData.level = LEVELS[levelKey];
        return userData;
    };
    
    const saveUserData = (phone, userData) => {
        localStorage.setItem(normalizePhone(phone), JSON.stringify({ submissionCount: userData.submissionCount }));
    };

    // --- –û–°–ù–û–í–ù–ê–Ø –õ–û–ì–ò–ö–ê ---
    function updateUIWithUserData() {
        const phone = phoneInput.value;
        if (!isValidPhone(phone)) {
            document.getElementById('user-profile').classList.add('hidden');
            return;
        }

        const userData = getUserData(phone);
        state.userLevel = userData.level;
        state.submissionCount = userData.submissionCount;

        // --- –û–±–Ω–æ–≤–ª—è–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ ---
        document.getElementById('profile-phone').textContent = phone;
        document.getElementById('profile-count').textContent = userData.submissionCount;
        
        const badge = document.getElementById('profile-level-badge');
        badge.textContent = userData.level.name;
        badge.className = `font-bold text-sm px-3 py-1 rounded-full ${userData.level.color}`;
        
        // --- –õ–æ–≥–∏–∫–∞ –¥–ª—è –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä–∞ –∏ —Ç–µ–∫—Å—Ç–∞ ---
        const progressBar = document.getElementById('progress-bar');
        const nextLevelText = document.getElementById('next-level-text');

        const levelKeys = Object.keys(LEVELS).map(Number);
        const currentLevelIndex = levelKeys.findIndex(key => LEVELS[key] === userData.level);
        const isMaxLevel = currentLevelIndex === levelKeys.length - 1;

        let progressPercent = 0;

        if (isMaxLevel) {
            progressPercent = 100;
            nextLevelText.textContent = "–ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–Ω–≥ –¥–æ—Å—Ç–∏–≥–Ω—É—Ç! üéâ";
        } else {
            const nextLevelKey = levelKeys[currentLevelIndex + 1];
            const nextLevelThreshold = LEVELS[nextLevelKey].threshold;
            const prevLevelThreshold = userData.level.threshold;
            
            const reviewsInCurrentLevel = userData.submissionCount - prevLevelThreshold;
            const reviewsNeededForNext = nextLevelThreshold - prevLevelThreshold;
            
            progressPercent = Math.floor((reviewsInCurrentLevel / reviewsNeededForNext) * 100);
            
            const reviewsLeft = nextLevelThreshold - userData.submissionCount;
            nextLevelText.textContent = `–î–æ "${LEVELS[nextLevelKey].name}": ${reviewsLeft} –æ—Ç–∑.`;
        }

        progressBar.style.width = `${progressPercent}%`;

        document.getElementById('user-profile').classList.remove('hidden');
        calculateReward();
    }

    function calculateReward() {
        let totalPoints = 0;
        if (reviewTextInput.value.length > 10) {
            totalPoints += REWARDS.BASE_REVIEW;
        }

        const finalPoints = Math.ceil(totalPoints * state.userLevel.multiplier);
        state.points = finalPoints;

        if (finalPoints > 0) {
            rewardContainer.innerHTML = `–ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–æ–µ –≤–æ–∑–Ω–∞–≥—Ä–∞–∂–¥–µ–Ω–∏–µ: <span class="text-xl">${finalPoints}</span> –±–∞–ª–ª–æ–≤`;
            rewardContainer.classList.remove('opacity-0', 'scale-95');
        } else {
            rewardContainer.classList.add('opacity-0', 'scale-95');
        }
    }
    
    async function handleSubmit(e) {
        e.preventDefault();
        formError.classList.add('hidden');

        if (!isValidPhone(phoneInput.value) || nameInput.value.trim() === '' || reviewTextInput.value.trim() === '') {
            formError.textContent = '–ù–µ–æ–±—Ö–æ–¥–∏–º–æ –∑–∞–ø–æ–ª–Ω–∏—Ç—å –≤—Å–µ –ø–æ–ª—è.';
            formError.classList.remove('hidden');
            return;
        }
        if (reviewTextInput.value.length < 50) {
             formError.textContent = '–û—Ç–∑—ã–≤ —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∏–π. –¢—Ä–µ–±—É–µ—Ç—Å—è –±–æ–ª—å—à–µ –¥–µ—Ç–∞–ª–µ–π (–º–∏–Ω–∏–º—É–º 50 –∑–Ω–∞–∫–æ–≤).';
             formError.classList.remove('hidden');
             return;
        }
        
        submitBtn.disabled = true;
        submitBtn.textContent = '–û—Ç–ø—Ä–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö...';

        const userData = getUserData(phoneInput.value);
        userData.submissionCount += 1;
        saveUserData(phoneInput.value, userData);
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Ä–∞–Ω–≥ –≤ state –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π
        updateUIWithUserData(); 

        const dataToSend = {
            name: nameInput.value,
            phone: phoneInput.value,
            level: state.userLevel.name, 
            reviewText: reviewTextInput.value,
            pointsAwarded: state.points
        };

        try {
            await fetch(GOOGLE_SCRIPT_URL, {
                method: 'POST',
                mode: 'no-cors',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(dataToSend)
            });
            showSuccessMessage();
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ:', error);
            formError.textContent = '–°–±–æ–π –ø—Ä–∏ –ø–µ—Ä–µ–¥–∞—á–µ –¥–∞–Ω–Ω—ã—Ö. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.';
            formError.classList.remove('hidden');
        } finally {
            submitBtn.disabled = false;
            submitBtn.textContent = '–û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤ –∏ –ø–æ–ª—É—á–∏—Ç—å –±–∞–ª–ª—ã';
        }
    }

    function showSuccessMessage() {
        document.getElementById('main-content').classList.add('hidden');
        const successText = document.getElementById('success-text');
        successText.innerHTML = `–í–æ–∑–Ω–∞–≥—Ä–∞–∂–¥–µ–Ω–∏–µ –≤ —Ä–∞–∑–º–µ—Ä–µ <strong class="text-emerald-300">${state.points} –±–∞–ª–ª–æ–≤</strong> –∑–∞—á–∏—Å–ª–µ–Ω–æ. –ë–ª–∞–≥–æ–¥–∞—Ä–∏–º –∑–∞ —Å–æ–¥–µ–π—Å—Ç–≤–∏–µ!`;
        document.getElementById('success-message').classList.remove('hidden');
    }

    function resetForm() {
        document.getElementById('success-message').classList.add('hidden');
        document.getElementById('main-content').classList.remove('hidden');
        form.reset();
        state.points = 0;
        rewardContainer.classList.add('opacity-0', 'scale-95');
        document.getElementById('user-profile').classList.add('hidden');
        setRandomMission();
    }
    
    function setRandomMission() {
        const missionTextEl = document.getElementById('mission-text');
        missionTextEl.textContent = MISSIONS[Math.floor(Math.random() * MISSIONS.length)];
    }

    // --- –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ---
    window.onload = () => {
        IMask(phoneInput, { mask: '+{7} (000) 000-00-00' });
        
        phoneInput.addEventListener('input', updateUIWithUserData);
        reviewTextInput.addEventListener('input', calculateReward);
        form.addEventListener('submit', handleSubmit);
        document.getElementById('leave-another-review-btn').addEventListener('click', resetForm);
        
        setRandomMission();
    };
</script>
</body>
</html>
